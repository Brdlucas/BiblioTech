{% extends 'base.html.twig' %}

{% block title %}Résultats de la recherche{% endblock %}

{% block body %}
    <div class="container mx-auto p-4">
        <h1 class="text-2xl font-bold mb-4">Résultats de la recherche</h1>
        
        <div class="mb-4 flex flex-col md:flex-row md:items-center md:justify-between">
            <input type="text" id="search" placeholder="Rechercher un livre..." class="p-2 border rounded w-full md:w-1/3" oninput="filterBooks()">
            <select id="filterAuthor" class="p-2 border rounded md:ml-4 mt-2 md:mt-0" onchange="filterBooks()">
                <option value="">Filtrer par auteur</option>
            </select>
            <select id="filterGenre" class="p-2 border rounded md:ml-4 mt-2 md:mt-0" onchange="filterBooks()">
                <option value="">Filtrer par genre</option>
            </select>
        </div>
        
        {% if results.items is not empty %}
            <div id="bookList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {% for item in results.items %}
                    <div class="bg-white p-4 rounded-lg shadow-md book-card" data-author="{{ item.volumeInfo.authors|join(', ') }}" data-genre="{{ item.volumeInfo.categories|join(', ')|default('Autre') }}">
                        <img src="{{ item.volumeInfo.imageLinks.thumbnail|default('https://via.placeholder.com/128x192') }}" alt="Couverture du livre" class="w-full h-auto rounded-md mb-2">
                        <h2 class="text-lg font-semibold">{{ item.volumeInfo.title }}</h2>
                        <p class="text-gray-600">Auteur(s) : {{ item.volumeInfo.authors|join(', ') }}</p>
                        <p class="text-gray-500">Genre : {{ item.volumeInfo.categories|join(', ')|default('Autre') }}</p>
                        <button class="mt-2 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600" onclick="toggleSummary(this)">Afficher le résumé</button>
                        <p class="text-sm text-gray-700 mt-2 hidden">{{ item.volumeInfo.description|default('Aucune description disponible.') }}</p>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <p class="text-gray-500">Aucun résultat trouvé.</p>
        {% endif %}
    </div>
    
    <script>
        function toggleSummary(button) {
            let summary = button.nextElementSibling;
            summary.classList.toggle('hidden');
        }

        function filterBooks() {
            let searchQuery = document.getElementById('search').value.toLowerCase();
            let authorFilter = document.getElementById('filterAuthor').value.toLowerCase();
            let genreFilter = document.getElementById('filterGenre').value.toLowerCase();
            let books = document.querySelectorAll('.book-card');

            books.forEach(book => {
                let title = book.querySelector('h2').innerText.toLowerCase();
                let author = book.dataset.author.toLowerCase();
                let genre = book.dataset.genre.toLowerCase();
                
                let matchesSearch = title.includes(searchQuery);
                let matchesAuthor = authorFilter === "" || author.includes(authorFilter);
                let matchesGenre = genreFilter === "" || genre.includes(genreFilter);
                
                if (matchesSearch && matchesAuthor && matchesGenre) {
                    book.style.display = "block";
                } else {
                    book.style.display = "none";
                }
            });
        }

        window.onload = function() {
            let authors = new Set();
            let genres = new Set();
            document.querySelectorAll('.book-card').forEach(book => {
                authors.add(book.dataset.author);
                genres.add(book.dataset.genre);
            });
            
            let authorSelect = document.getElementById('filterAuthor');
            authors.forEach(author => {
                let option = document.createElement('option');
                option.value = author;
                option.textContent = author;
                authorSelect.appendChild(option);
            });
            
            let genreSelect = document.getElementById('filterGenre');
            genres.forEach(genre => {
                let option = document.createElement('option');
                option.value = genre;
                option.textContent = genre;
                genreSelect.appendChild(option);
            });
        }
    </script>
{% endblock %}
